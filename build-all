#!/bin/bash

PATH="/var/named/bin:/usr/bin:/usr/sbin"

export TZ=UTC

set -o errexit	# set -e
set -o nounset	# set -u

renice --priority 19 --pid $$ > /dev/null
ionice --class 3     --pid $$ > /dev/null

cd /var/named

KEYDIR="keys"
mkdir -p $KEYDIR
mkdir -p data
mkdir -p dynamic

clean-all

generate-dns-glue
generate-root-certs
generate-ssh-fingerprint

generate-tlsa
update-serials flatcap.org.db
update-serials flatcap.xyz.db
update-serials russon.org.db

START=$(date "+%Y %m")
NEXT=$(date "+%Y %m" -d "1 month")

generate-ksk flatcap.org $START
generate-zsk flatcap.org $START
generate-zsk flatcap.org $NEXT

generate-ksk russon.org  $START
generate-zsk russon.org  $START
generate-zsk russon.org  $NEXT

sign-zone flatcap.org
sign-zone russon.org

set-to-publish-date.sh "$KEYDIR"/*
fix-perms
show-keys

