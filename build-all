#!/bin/bash

PATH="/var/named/bin:/usr/bin:/usr/sbin"
source log.sh

export TZ="UTC"

set -o errexit	# set -e
set -o nounset	# set -u

renice --priority 19 --pid $$ > /dev/null
ionice --class 3     --pid $$ > /dev/null

shopt -s nullglob

function finish()
{
	local RETVAL=$?
	[ $RETVAL = 0 ] || log_error "${0##*/} failed: $RETVAL"
}

trap finish EXIT

cd /var/named

[ $# = 0 ] && exit 2

mkdir --parents "$DNSSEC_KEY_DIR"
mkdir --parents data
mkdir --parents dynamic

clean all

generate-dns-glue
generate-root-certs
generate-ssh-fingerprint

generate-tlsa $DNSSEC_DOMAINS
update-serials $DNSSEC_DOMAINS

START=$(date "+%Y %m")

for d in $DNSSEC_DOMAINS; do
	generate-ksk $d $START
	generate-zsk $d $START
	sign-zone $d
done

set-to-publish-date
fix-perms
show-keys

