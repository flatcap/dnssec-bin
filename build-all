#!/bin/bash

PATH="/usr/bin:/usr/sbin"

set -o errexit	# set -e
set -o nounset	# set -u

renice --priority 19 --pid $$ > /dev/null
ionice --class 3     --pid $$ > /dev/null

cd /var/named

KEYDIR=keys
mkdir -p $KEYDIR
mkdir -p data
mkdir -p dynamic

bin/clean-all

bin/generate-dns-glue
bin/generate-root-certs
bin/generate-ssh-fingerprint

bin/generate-tlsa
bin/update-serials flatcap.org.db
bin/update-serials flatcap.xyz.db
bin/update-serials russon.org.db

START=$(date "+%Y %m")
NEXT=$(date "+%Y %m" -d "1 month")

bin/generate-ksk flatcap.org $START
bin/generate-zsk flatcap.org $START
bin/generate-zsk flatcap.org $NEXT

bin/generate-ksk russon.org  $START
bin/generate-zsk russon.org  $START
bin/generate-zsk russon.org  $NEXT

bin/sign-zone flatcap.org
bin/sign-zone russon.org

bin/set-to-publish-date.sh keys/*
bin/fix-perms

echo
echo -e "\e[1;32mKSKs\e[0m"
ls -1 -tr  keys/*.key | while read x; do
	grep -q "key-signing" "$x" || continue
	echo $x
	grep -e Activate -e Inactive $x | sed 's/^/\t/'
done

echo
echo -e "\e[1;32mZSKs\e[0m"
ls -1 -tr  keys/*.key | while read x; do
	grep -q "zone-signing" "$x" || continue
	echo $x
	grep -e Activate -e Inactive $x | sed 's/^/\t/'
done


